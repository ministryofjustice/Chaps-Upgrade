# Stage 1: Build ChapsDotNet (.NET 8)
FROM mcr.microsoft.com/dotnet/sdk:8.0-windowsservercore-ltsc2019 AS build-dotnet
WORKDIR /src

# Copy and restore ChapsDotNet dependencies
COPY ChapsDotNet/ChapsDotNET/ChapsDotNET.csproj ChapsDotNet/ChapsDotNET/
COPY ChapsDotNet/ChapsDotNET.Data/ChapsDotNET.Data.csproj ChapsDotNet/ChapsDotNET.Data/
COPY ChapsDotNet/ChapsDotNET.Business/ChapsDotNET.Business.csproj ChapsDotNet/ChapsDotNET.Business/

# Copy the rest of the project files
COPY ChapsDotNet/ChapsDotNET/ ./ChapsDotNet/ChapsDotNET/
COPY ChapsDotNet/ChapsDotNET.Data/ ./ChapsDotNet/ChapsDotNET.Data/
COPY ChapsDotNet/ChapsDotNET.Business/ ./ChapsDotNet/ChapsDotNET.Business/

WORKDIR /src/ChapsDotNet/ChapsDotNET
RUN dotnet restore ChapsDotNET.csproj

WORKDIR /src/ChapsDotNet/ChapsDotNET
# Publish
RUN dotnet publish ChapsDotNET.csproj -c Release -o /out

# Stage 2: Build CHAPS (.NET Framework 4.8)
FROM mcr.microsoft.com/dotnet/framework/sdk:4.8-windowsservercore-ltsc2019 AS build-chaps
WORKDIR /app

# Copy CHAPS project and restore dependencies
COPY CHAPS/Chaps/Chaps.csproj CHAPS/
RUN nuget restore CHAPS/Chaps.csproj

# Copy CHAPS solution and restore dependencies
COPY CHAPS/. ./
RUN nuget restore CHAPS.sln

# Build CHAPS
RUN msbuild /p:Configuration=Release /p:PlatformTarget=AnyCPU /p:OutputPath=bin/Release

# Verify the directory structure after building CHAPS
RUN dir /app/Chaps

# Stage 3: Combine & Run
FROM mcr.microsoft.com/dotnet/framework/aspnet:4.8-windowsservercore-ltsc2019 AS runtime
WORKDIR /app

# Copy from build-dotnet
COPY --from=build-dotnet /out ./ChapsDotNet

# Copy from build-chaps
COPY --from=build-chaps /app/Chaps/bin/Release ./CHAPS

# Expose the ports required by both applications
EXPOSE 7226
EXPOSE 44300

# Entry point script to run both apps simultaneously (simple example)
CMD ["cmd", "/c", "start dotnet ChapsDotNet/ChapsDotNET.dll && start C:\\CHAPS\\CHAPS.exe"]
